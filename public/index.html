<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini Image Proxy</title>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--primary:#3b82f6;--success:#10b981;--warn:#f59e0b;--error:#ef4444;--text:#f1f5f9;--border:#334155;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;}
    .container{max-width:800px;width:100%;background:var(--card);border-radius:16px;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,.5);}
    .header{text-align:center;margin-bottom:24px;}.header h1{font-size:28px;margin-bottom:8px;color:var(--primary);}.header p{color:#94a3b8;font-size:14px;}
    .input-group{margin-bottom:16px;}.input-group label{display:block;margin-bottom:8px;font-weight:500;font-size:14px;}
    .input-group input,.input-group textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--bg);color:var(--text);font-size:15px;}
    .input-group input:focus,.input-group textarea:focus{outline:none;border-color:var(--primary);}
    .checkbox-group{display:flex;align-items:center;gap:8px;margin:12px 0;cursor:pointer;}.checkbox-group input{width:auto;cursor:pointer;}
    .btn{width:100%;padding:14px;background:var(--primary);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin:12px 0;}
    .btn:hover{background:#2563eb;}.btn:disabled{background:#475569;cursor:not-allowed;}
    #status{padding:12px;border-radius:8px;text-align:center;margin:12px 0;font-weight:500;}
    .status-success{color:var(--success);background:rgba(16,185,129,.1);border:1px solid var(--success);}
    .status-loading{color:var(--primary);background:rgba(59,130,246,.1);border:1px solid var(--primary);}
    .status-warn{color:var(--warn);background:rgba(245,158,11,.1);border:1px solid var(--warn);}
    .status-error{color:var(--error);background:rgba(239,68,68,.1);border:1px solid var(--error);}
    #imageOut{max-width:100%;height:400px;border-radius:12px;background:var(--bg);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;color:#94a3b8;object-fit:contain;}
    .api-info{background:rgba(59,130,246,.1);border:1px solid var(--primary);border-radius:10px;padding:14px;margin:12px 0;}
    .api-info h3{margin-bottom:8px;color:var(--primary);font-size:16px;}.api-info div{font-size:13px;margin:4px 0;word-break:break-all;}
    details{margin-top:16px;border:1px solid var(--border);border-radius:8px;padding:12px;background:var(--bg);}
    summary{cursor:pointer;font-weight:500;padding:8px;}
    pre{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:6px;font-size:12px;max-height:250px;overflow:auto;white-space:pre-wrap;margin-top:8px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ–¼ï¸ Gemini Image Proxy</h1>
      <p>è¼¸å…¥ä¸Šæ¸¸ API åœ°å€ç”Ÿæˆåœ–åƒ</p>
    </div>
    
    <div class="input-group">
      <label for="targetUrl">ä¸Šæ¸¸ API ç«¯é»</label>
      <input type="url" id="targetUrl" placeholder="https://api-integrations.appmedo.com/..." value="https://api-integrations.appmedo.com/app-7r29gu4xs001/api-Xa6JZ58oPMEa/v1beta/models/gemini-3-pro-image-preview:generateContent">
    </div>
    
    <div class="input-group">
      <label for="apiKey">API Keyï¼ˆé¸å¡«ï¼Œå„ªå…ˆç”¨ç’°å¢ƒè®Šæ•¸ï¼‰</label>
      <input type="password" id="apiKey" placeholder="ç•™ç©ºä½¿ç”¨ Worker ç’°å¢ƒè®Šæ•¸">
    </div>
    
    <div class="input-group">
      <label for="prompt">åœ–åƒæè¿°</label>
      <textarea id="prompt" rows="3" placeholder="å¯æ„›çš„è²“å’ªåœ¨é¦™æ¸¯æ²™ç”°å€æ•£æ­¥">å¯æ„›çš„è²“å’ªåœ¨é¦™æ¸¯æ²™ç”°å€æ•£æ­¥</textarea>
    </div>
    
    <div class="checkbox-group">
      <input type="checkbox" id="openaiFormat">
      <label for="openaiFormat">OpenAI æ ¼å¼è¼¸å‡º</label>
    </div>
    
    <button id="generateBtn" onclick="generateImage()">ğŸ¨ ç”Ÿæˆåœ–åƒ</button>
    
    <div id="status"></div>
    
    <div id="apiInfo" class="api-info" style="display:none;">
      <h3>ğŸ“¡ API è¼¸å‡ºè³‡è¨Š</h3>
      <div><strong>æœ€çµ‚ç«¯é»:</strong> <span id="finalEndpoint"></span></div>
      <div><strong>OpenAI æ¨¡å¼:</strong> <span id="formatMode"></span></div>
    </div>
    
    <img id="imageOut" alt="ç­‰å¾…ç”Ÿæˆ">
    
    <details>
      <summary>ğŸ”§ Raw API Log</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <script>
    const targetUrlInput = document.getElementById('targetUrl');
    const apiKeyInput = document.getElementById('apiKey');
    const promptInput = document.getElementById('prompt');
    const openaiFormatCb = document.getElementById('openaiFormat');
    const generateBtn = document.getElementById('generateBtn');
    const statusEl = document.getElementById('status');
    const apiInfoEl = document.getElementById('apiInfo');
    const finalEndpointSpan = document.getElementById('finalEndpoint');
    const formatModeSpan = document.getElementById('formatMode');
    const imageOut = document.getElementById('imageOut');
    const logEl = document.getElementById('log');

    async function generateImage() {
      generateBtn.disabled = true;
      generateBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
      statusEl.textContent = 'â³ è«‹æ±‚ä¸­...';
      statusEl.className = 'status-loading';
      imageOut.src = '';
      imageOut.alt = 'ç”Ÿæˆä¸­...';
      apiInfoEl.style.display = 'none';
      logEl.textContent = '';

      try {
        const prompt = promptInput.value.trim();
        if (!prompt) throw new Error('è«‹è¼¸å…¥åœ–åƒæè¿°');

        const targetUrl = targetUrlInput.value.trim();
        if (!targetUrl) throw new Error('è«‹è¼¸å…¥ä¸Šæ¸¸ API ç«¯é»');

        // è«‹æ±‚æœ¬åŸŸ /proxyï¼ˆWorker ä»£ç†ï¼‰
        const body = {
          target_url: targetUrl,
          key: apiKeyInput.value.trim() || undefined,
          prompt: prompt,
          openai: openaiFormatCb.checked,
          response_mime_type: 'image/png'
        };

        const response = await fetch('/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }

        const data = await response.json();
        logEl.textContent = JSON.stringify(data, null, 2);

        // API è³‡è¨Š
        const finalUrl = response.headers.get('x-final-destination') || targetUrl;
        const mode = response.headers.get('x-openai-mode') || 'native';
        finalEndpointSpan.textContent = finalUrl;
        formatModeSpan.textContent = mode === 'enabled' ? 'âœ… å•Ÿç”¨' : 'âŒ åŸç”Ÿ Gemini';
        apiInfoEl.style.display = 'block';

        // è§£æåœ–åƒ
        let imgB64 = '';
        if (mode === 'enabled' && data.data?.[0]?.b64_json) {
          imgB64 = data.data[0].b64_json;
        } else if (data.candidates?.[0]?.content?.parts?.[0]?.inline_data?.data) {
          imgB64 = data.candidates[0].content.parts[0].inline_data.data;
        }

        if (imgB64) {
          imageOut.src = `data:image/png;base64,${imgB64}`;
          imageOut.alt = 'ç”Ÿæˆçš„åœ–åƒ';
          statusEl.textContent = 'âœ… ç”ŸæˆæˆåŠŸ';
          statusEl.className = 'status-success';
        } else {
          statusEl.textContent = 'âš ï¸ ç„¡åœ–ç‰‡æ•¸æ“š';
          statusEl.className = 'status-warn';
          imageOut.alt = 'ç„¡åœ–ç‰‡';
        }
      } catch (error) {
        statusEl.textContent = `âŒ ${error.message}`;
        statusEl.className = 'status-error';
        logEl.textContent = `éŒ¯èª¤: ${error.message}`;
        imageOut.alt = 'ç”Ÿæˆå¤±æ•—';
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ğŸ¨ ç”Ÿæˆåœ–åƒ';
      }
    }
  </script>
</body>
</html>
