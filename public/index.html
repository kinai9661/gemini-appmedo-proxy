<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini Image Proxy</title>
  <style>
    :root{--bg:#0f172a;--card:#1e293b;--primary:#3b82f6;--success:#10b981;--warn:#f59e0b;--error:#ef4444;--text:#f1f5f9;--border:#334155;}
    *{box-sizing:border-box;margin:0;padding:0;}body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;font-size:16px;line-height:1.5;}
    .container{max-width:800px;width:100%;background:var(--card);border-radius:16px;padding:24px;box-shadow:0 20px 25px -5px rgba(0,0,0,.5);}.header{text-align:center;margin-bottom:24px;}.header h1{font-size:28px;margin-bottom:8px;color:var(--primary);}.header p{color:#94a3b8;}
    .input-group{margin-bottom:16px;}.input-group label{display:block;margin-bottom:8px;font-weight:500;}.input-group input{width:100%;padding:14px;border:1px solid var(--border);border-radius:12px;background:var(--bg);color:var(--text);font-size:16px;transition:border-color .2s;}
    .input-group input:focus{outline:none;border-color:var(--primary);}.checkbox-group{display:flex;align-items:center;gap:8px;margin:16px 0;cursor:pointer;}.checkbox-group input{width:auto;}
    .btn{width:100%;padding:16px;background:var(--primary);color:white;border:none;border-radius:12px;font-size:18px;font-weight:600;cursor:pointer;transition:background .2s;margin:16px 0;}.btn:hover{background:#2563eb;}.btn:disabled{background:#475569;cursor:not-allowed;}
    #status{padding:12px;border-radius:10px;font-weight:600;text-align:center;margin:16px 0;font-size:16px;}.status-success{color:var(--success);background:rgba(16,185,129,.1);border:1px solid var(--success);}.status-loading{color:var(--primary);background:rgba(59,130,246,.1);border:1px solid var(--primary);}.status-warn{color:var(--warn);background:rgba(245,158,11,.1);border:1px solid var(--warn);}.status-error{color:var(--error);background:rgba(239,68,68,.1);border:1px solid var(--error);}
    #imageOut{max-width:100%;height:400px;border-radius:12px;background:var(--bg);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;color:#94a3b8;overflow:hidden;object-fit:contain;}.api-info{background:rgba(59,130,246,.1);border:1px solid var(--primary);border-radius:12px;padding:16px;margin:16px 0;}.api-info h3{margin-bottom:8px;color:var(--primary);}.api-info pre{background:var(--bg);padding:12px;border-radius:8px;font-size:14px;overflow:auto;max-height:200px;}
    details{margin-top:16px;}summary{cursor:pointer;padding:12px;background:var(--bg);border-radius:8px;font-weight:500;}pre{background:var(--bg);border:1px solid var(--border);padding:16px;border-radius:8px;font-size:12px;height:250px;overflow:auto;white-space:pre-wrap;}
    @media (max-width:600px){.container{padding:16px;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ–¼ï¸ Gemini Image Proxy</h1>
      <p>è¼¸å…¥ API ç«¯é»ç”Ÿæˆåœ–åƒ</p>
    </div>
    <div class="input-group">
      <label for="apiEndpoint">API ç«¯é»åœ°å€</label>
      <input type="url" id="apiEndpoint" placeholder="https://your-worker.workers.dev/proxy/generateContent" value="https://kinaai.eu.cc/v1/proxy/generateContent">
    </div>
    <div class="input-group">
      <label for="prompt">åœ–åƒæè¿°</label>
      <textarea id="prompt" rows="3" placeholder="å¯æ„›çš„è²“å’ªåœ¨é¦™æ¸¯æ²™ç”°å€æ•£æ­¥">å¯æ„›çš„è²“å’ªåœ¨é¦™æ¸¯æ²™ç”°å€æ•£æ­¥</textarea>
    </div>
    <div class="checkbox-group">
      <input type="checkbox" id="openaiFormat">
      <label for="openaiFormat">OpenAI æ ¼å¼è¼¸å‡º</label>
    </div>
    <button id="generateBtn" onclick="generateImage()">ç”Ÿæˆåœ–åƒ</button>
    <div id="status"></div>
    <div id="apiInfo" class="api-info" style="display:none;">
      <h3>ğŸ“¡ API è¼¸å‡ºè³‡è¨Š</h3>
      <div>ç«¯é»: <span id="finalEndpoint"></span></div>
      <div>OpenAI æ¨¡å¼: <span id="formatMode"></span></div>
    </div>
    <img id="imageOut" alt="ç”Ÿæˆåœ–åƒ">
    <details>
      <summary>ğŸ”§ Raw API Log</summary>
      <pre id="log"></pre>
    </details>
  </div>

  <script>
    const apiEndpointInput = document.getElementById('apiEndpoint');
    const promptInput = document.getElementById('prompt');
    const openaiFormatCb = document.getElementById('openaiFormat');
    const generateBtn = document.getElementById('generateBtn');
    const statusEl = document.getElementById('status');
    const apiInfoEl = document.getElementById('apiInfo');
    const finalEndpointSpan = document.getElementById('finalEndpoint');
    const formatModeSpan = document.getElementById('formatMode');
    const imageOut = document.getElementById('imageOut');
    const logEl = document.getElementById('log');

    async function generateImage() {
      generateBtn.disabled = true;
      generateBtn.textContent = 'ç”Ÿæˆä¸­...';
      statusEl.textContent = 'â³ è«‹æ±‚ API...';
      statusEl.className = 'status-loading';
      imageOut.src = '';
      imageOut.alt = 'ç”Ÿæˆä¸­...';
      imageOut.style.backgroundImage = '';
      apiInfoEl.style.display = 'none';
      logEl.textContent = '';

      try {
        const apiUrl = apiEndpointInput.value.trim();
        if (!apiUrl) throw new Error('è«‹è¼¸å…¥ API ç«¯é»');

        const body = {
          prompt: promptInput.value.trim(),
          openai: openaiFormatCb.checked,
          response_mime_type: 'image/png'
        };

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const data = await response.json();
        logEl.textContent = JSON.stringify(data, null, 2);

        // API è³‡è¨Š
        const finalUrl = response.headers.get('x-final-destination') || apiUrl;
        const mode = response.headers.get('x-openai-mode') || (openaiFormatCb.checked ? 'enabled' : 'native');
        finalEndpointSpan.textContent = finalUrl;
        formatModeSpan.textContent = mode === 'enabled' ? 'âœ… å•Ÿç”¨' : 'âŒ åŸç”Ÿ';
        apiInfoEl.style.display = 'block';

        // åœ–åƒ
        let imgB64 = '';
        if (mode === 'enabled' && data.data?.[0]?.b64_json) {
          imgB64 = data.data[0].b64_json;
        } else if (data.candidates?.[0]?.content?.parts?.[0]?.inline_data?.data) {
          imgB64 = data.candidates[0].content.parts[0].inline_data.data;
        }
        if (imgB64) {
          imageOut.src = `data:image/png;base64,${imgB64}`;
          statusEl.textContent = 'âœ… ç”ŸæˆæˆåŠŸ';
          statusEl.className = 'status-success';
        } else {
          statusEl.textContent = 'âš ï¸ ç„¡åœ–ç‰‡æ•¸æ“š';
          statusEl.className = 'status-warn';
          imageOut.alt = 'ç„¡åœ–ç‰‡';
        }
      } catch (error) {
        statusEl.textContent = `âŒ ${error.message}`;
        statusEl.className = 'status-error';
        logEl.textContent += `\néŒ¯èª¤: ${error.message}`;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'ç”Ÿæˆåœ–åƒ';
      }
    }

    // Enter å¿«æ·
    document.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !generateBtn.disabled) generateImage();
    });
  </script>
</body>
</html>
